# 分人対応 音声文字起こし（16時間セッション）Web SSOT＋クラウドSTT 要件定義書

**作成日**: 2026-01-15  
**バージョン**: 1.4.1  
**ステータス**: ドラフト（統合更新版）

---

## 1. プロジェクト概要

### 1.1 基本情報

| 項目 | 内容 |
|---|---|
| プロジェクト名 | 分人対応 音声文字起こし（16時間セッション） |
| 形態 | Web/Backend＝SSOT（Single Source of Truth）、Android＝収集（録音）クライアント |
| STT方式 | **クラウドSTTを基本**（オンラインで処理） |
| データ境界 | **テキストは送信・保存**／**音声は短期保持**（永続保存しない） |
| 分人 | 初期2分人（仕事/家庭）＋デフォルト5分人（例：WORK/HOME/PRIVATE/MOVE/UNKNOWN）＋追加3分人（定義必須） |
| ルールUI | 分人ごとの個別ルールではなく **統一の条件分岐ツリー**（終端＝分人） |
| オフライン | 基本オンライン前提だが、**オフライン時は端末に音声キューを作成**し、回線復帰後に送信 |
| 主な価値 | 日次：提案→確定、週次：実施確認。記憶は蓄積・新しい優先。詳細閲覧はWebでも可 |

### 1.2 背景と課題
- 分人ルールや蒸留、記憶編集は運用しながら変わるため、Web側へ集約して維持コストを抑える。
- 音声はセンシティブなので、端末/サーバ双方で **短期保持**とし、永続化しない。
- オンライン前提を基本としつつ、現実の電波断に備えて **容量制限付きの音声キュー**を持つ。

### 1.3 ゴールとスコープ

**ゴール**
- 音声→テキスト化→分人別の記憶育成（蒸留→採用/編集→保存）が安定運用できる。
- ルール更新は **セッション開始時に固定**し、セッション中は不変。更新は次回Startから適用。
- 採用済みMemoryは上書きせず蓄積し、参照時は **新しい情報を優先**する（矛盾は許容）。

**スコープ（今回やる）**
- Android：FGS録音、10分/無音で区切り、音声送信、オフライン音声キュー（容量制限・残量通知）、状態表示
- Backend/Web：認証/RLS、分岐ツリー管理、STT連携、テキスト保存、蒸留、提案の確定/週次実施記録、メモリー蓄積、最小監査ログ
- 分人：初期分人、分岐ツリー、位置共有ON/OFF時の挙動（ジオフェンス条件の可否と通知）

**スコープ外（今回やらない）**
- 音声の永続保存（いかなる保存先でも禁止）
- ユーザー操作なしの自動開始（端末再起動直後の自動開始等）
- Notion/他ストレージへの保存先切替（将来）
- 分人状態推定（Won’t：後述）
- 法人向け運用（個人利用を前提）

---

## 2. 成功指標（KPI）と一般的な数値目標（暫定）

> 数値は「初期の一般的な目安」。実測で調整する前提。

### 2.1 KPI（取得要件のみ）
- **チェックイン率**：日次の「提案→確定」が完了した日/日数
- **提案実行率**：週次で「実施=Yes」になった提案/確認対象提案

### 2.2 数値目標（暫定）
| 区分 | 指標 | 目標 |
|---|---|---|
| 録音 | Start→録音開始 | P95 ≤ 2秒 |
| セグメント | 最大セグメント長 | 10分（固定） |
| 無音区切り | 無音閾値 | 既定 5秒（3/5/10秒から選択） |
| STT | 10分セグメントの文字起こし完了 | P95 ≤ 120秒（応答＋保存まで） |
| 可用性 | Web/API稼働率 | 月間 99.5% |
| データ境界 | 音声永続化 | 0件（監査で確認） |
| ルール反映 | 反映タイミング | 次回Startから（セッション中不変） |
| オフライン | 音声キュー | ユーザー設定容量内で保持し、容量逼迫を通知 |

---

## 3. システム構成

### 3.1 コンポーネント
| コンポーネント | 役割 |
|---|---|
| Androidアプリ | 録音/区切り/送信/オフライン音声キュー/通知 |
| Backend API（HTTP API） | 音声受理、クラウドSTT実行、テキスト保存、ルール配布、蒸留、提案・週次実施記録 |
| Web管理画面 | 分岐ツリー管理、分人定義、セッション/テキスト閲覧、蒸留・提案レビュー、メモリー閲覧 |
| Supabase | Auth、DB、RLS（本人のみ） |
| Cloud STT Provider | 音声→テキスト（短期処理、音声永続化しない） |

### 3.2 データ境界（必須）
- SSOTに保存してよい：テキスト＋メタ（時刻、分人、分割理由、状態、ruleVersion等）
- 送信するが短期保持のみ：音声セグメント（STT入力）
- 保存しない：音声の永続ファイル（端末/サーバ）、継続的な位置生データのログ

---

## 4. 分人（Bunjin）仕様

### 4.1 初期分人
- **仕事（WORK）**：09:00–18:00  
- **家庭（HOME）**：それ以外  
（上記は初期設定。ユーザーが後で変更できる）

### 4.2 デフォルト分人と追加分人
- デフォルトで5分人（例：WORK/HOME/PRIVATE/MOVE/UNKNOWN）を用意
- 追加3分人（CUSTOM1〜3）は、利用する場合 **定義（名称＋分岐ツリー到達条件）が必須**。未定義なら終端として選択不可。

### 4.3 分人決定方式：統一条件分岐ツリー（必須）
- 単一の分岐ツリーで必ず1つの分人に到達する
- 各分岐ノードは必ず else（その他）分岐を持つ
- 位置取得不能/共有OFFの分岐を必ず持つ（終端は既定UNKNOWN等）
- **保存/公開バリデーション**：分岐ツリーは、**すべての終端（terminal）ノードに分人（bunjin）が設定されていない限り保存できない**（未設定が1つでもあれば保存・Publishを拒否する）。

### 4.4 ルール更新（確定）
- **ルール更新はセッション開始時に固定**し、セッション中は不変。
- 更新は **次回Startから適用**（録音中は変更不可）。

### 4.5 位置情報とジオフェンス条件
- 位置情報は必須ではない（曜日/時間/手動設定で代替可能）。
- ジオフェンス条件を分岐に設定できるのは **位置共有ONのときのみ**。
- 位置共有OFFの場合：
  - ジオフェンス条件の設定UIは無効化（設定不可）
  - 既にジオフェンス条件が設定済みなのにOFFになった場合、**ポップアップで通知**し、分岐評価は「位置不明」ルートへ落とす

---

## 5. 音声保持とイベント駆動削除（必須）

### 5.1 端末側（イベント駆動）
- 音声はセグメント単位で保持し、以下イベントで削除する
  - `UploadAccepted`（サーバ受理ACK）→ **端末側音声を直ちに削除**
  - `UploadFailedFinal`（最終失敗確定）→ **端末側音声を削除**
- オフライン時はキューに入るため、削除は「受理ACK」まで保留される

### 5.2 サーバ側（成功/失敗により保持判断）
- 音声はSTT処理の一時領域にのみ保持
- `STTSucceeded` → テキスト確定・保存完了後、**音声を直ちに削除**
- `STTFailed` または `STTDegraded` → **再文字起こしのため保持継続**
- `STTFailedFinal` → 失敗確定後、**音声を削除**

### 5.3 失敗判定と再文字起こし
- STT処理失敗（例：タイムアウト、5xx、空出力等）→ `STTFailed`
- 品質劣化（例：「同一文言の反復」が一定閾値を超える等）→ `STTDegraded`
- `STTFailed`/`STTDegraded` の場合、当該セグメントを再文字起こしする
- 最大リトライ回数：**TBD（初期は2回推奨）**
- リトライ後も失敗なら `STTFailedFinal` として確定し、テキストはERRORとして保存可能（TBD）

### 5.4 Won’t（課金で高度化）
- 上位モデル文字起こし
- raw/ノイズ除去2パターンSTT→統合処理
- **音声保持オプション（有料）**：
  - 既定は「短期保持（イベント駆動削除）」のまま。
  - 有料オプションとして、音声セグメントを **端末**または **クラウドサーバー** に保持する保存先を選べる。
  - 保持期間/上限容量はユーザーが設定でき、期間満了または上限超過時は自動削除する（詳細はTBD）。
  - 目的：後から聞き返し、品質改善、再文字起こし等（ただし学習利用は明示許諾なしは禁止）。



---

## 6. オフライン音声キュー（端末）要件（必須）

### 6.1 目的
- 回線断でも録音を継続し、復帰後に音声を送信してSTTを完了させる

### 6.2 ユーザー設定
- 端末に保持できる音声キュー容量をユーザーが設定できる
  - 設定単位：**容量（MB/GB）または推定保持時間（分）**（実装はどちらか一方でも可）
- 既定値：TBD（一般的に無理のない値を初期設定として設定）

### 6.3 動作
- オフライン時：セグメント音声をローカルキューへ保存（暗号化一時領域推奨）
- キュー容量が上限に達した場合：
  - 以降のセグメントは **保存不可**（失敗扱いにして通知）または **最古から上書き**（TBD：どちらか確定が必要）
- 回線復帰時：キューを古い順に送信し、`UploadAccepted` を受け取った音声から削除

### 6.4 残量通知（必須）
- キュー残量が「**残り20分相当**」を下回ったタイミングで、ユーザーへ通知（通知音あり/なしは設定でTBD）
- 「残り20分」は推定でよい（エンコード形式により誤差は許容）

---

## 7. 日次・週次（提案と確認）要件（Must）

> 「デイリーチェックインに何でも入れる」方式は禁止し、イベント単位で記録する。

### 7.1 日次：提案→確定＝チェックイン完了
- 日次で「概要提案」と「タスク提案」を提示し、ユーザーが確定したらその日をチェックイン完了とする
- 日次提案はSSOTに保存する（Proposal）

### 7.2 週次：実施したかどうか確認
- 週次で、期間中に確定した提案に対し「実施したか？」を記録する（Yes/No）
- これを提案実行率の算出根拠とする

### 7.3 SWLS（人生満足度尺度）：任意・自由回答（記録のみMust）
- SWLSは **必須入力ではない**
- 回答は「自由に応えられる」形式とし、**強制的な1〜7入力にしない**
- SWLSは日次チェックインとは別イベント/別テーブルで保持する（後述）

### 7.4 確定タスク・メモリー一覧ビュー（Must）
- 確定した「タスク」と「メモリー」を一覧で閲覧できるビューを提供する（Web画面で可）。
- ビューから**直接編集**できる（インライン編集または編集画面遷移）。
- 分人（bunjin）でフィルタ可能であること。

### 7.5 タスク（チェックボックス＋状態遷移）要件（Must）
- タスクは分人でタグ付け（bunjinId）される。
- タスク一覧は **未完了が上位**に出る（並び順の優先ルールを定義）。
- タスク状態は以下の4状態を持つ：
  - `TODO`（未着手）
  - `DOING`（実施中）
  - `DONE`（完了）
  - `ARCHIVED`（アーカイブ）
- 操作：チェックボックス（☑）のクリックで状態遷移する：
  - 1回目クリック：`TODO` → `DOING`
  - 2回目クリック：`DOING` → `DONE`
  - （任意/TBD）`DONE` → `TODO` に戻せるかは要確認
- 自動アーカイブ：`TODO`のまま **14日（2週間）** 経過したタスクは `ARCHIVED` に自動移行し、通常ビューから除外する。
  - アーカイブ閲覧はフィルタで可能（Should）。


---

## 8. データ設計（イベント駆動）

### 8.1 基本方針
- 主要行動は「イベント」として記録し、集計でKPIを算出する
- “巨大なDailyCheckInレコードに詰め込む”は禁止

### 8.2 主要イベント（例）
- `RuleTreeVersionPublished`
- `SessionStarted` / `SessionStopped`
- `AudioSegmentQueued`（端末）/ `AudioSegmentUploaded` / `UploadAccepted`
- `STTAttempted` / `STTSucceeded` / `STTFailed` / `STTDegraded` / `STTFailedFinal`
- `SegmentTextSaved`
- `ProposalGenerated` / `ProposalConfirmed` / `ProposalRejected`
- `WeeklyExecutionRecorded`
- `SWLSPrompted` / `SWLSSubmitted`
- `MemoryAdded`（採用で増えるのみ。上書きなし）
- `MemoryEdited`（メモリー編集）
- `TaskCreated` / `TaskEdited` / `TaskStatusChanged` / `TaskArchived`

### 8.3 テーブル（要約）
- users
- bunjins
- rule_trees / rule_tree_nodes / published_versions
- sessions（user_id, startedAt, endedAt, status, ruleVersion）
- segments（user_id, session_id, bunjin_id, startAt, endAt, splitReason, sttStatus, text, sttAttemptCount）
- proposals（user_id, dateKey, bunjin_id, type, text, status, confirmedAt）
- tasks（user_id, bunjin_id, text, status(TODO/DOING/DONE/ARCHIVED), createdAt, updatedAt, archivedAt）
- weekly_execution（user_id, weekKey, proposal_id, executed, answeredAt）
- swls_responses（user_id, dateKey, q1..q5 as TEXT, raw_json, submittedAt）
- memories（user_id, bunjin_id, type, text, createdAt, source_refs）
- audio_deletion_log（segment_id, deletedAt, reason）※音声本体なし（監査用）

---

## 9. 分人状態推定（Won’t）
- 分人ごとの状態判定ロジックは未定義のため **Won’t** とする
- 将来：SWLS推移、提案実施、チェックイン等から推定し、Androidへ概要反映（詳細はWeb）

---

## 10. 非機能要件（暫定数値）

### 10.1 性能
- Web/API応答：P95 ≤ 500ms（蒸留除く）
- 蒸留：対象1日分（segments ≤ 1000件想定）でP95 ≤ 60秒（暫定）

### 10.2 可用性
- 月間稼働率：99.5%
- RTO 4時間、RPO 24時間（暫定）

### 10.3 セキュリティ/監査（最小）
- 通信：TLS必須
- 認可：RLS必須（本人のみ）
- 監査ログ：ルール公開、音声削除イベント（音声本体なし）

---

## 11. TBD（影響度）

| No | 項目 | 内容 | 影響度 |
|---:|---|---|---|
| 1 | クラウドSTTプロバイダ | 具体サービス、保持/利用条件の確認 | High |
| 2 | 同文反復の判定 | 指標と閾値（誤爆防止） | Med |
| 3 | 最大リトライ回数 | 2回/3回など | Med |
| 4 | キュー満杯時の方針 | 最古上書き vs 新規破棄 | High |
| 5 | 既定キュー容量 | 初期設定値（MB/分） | Med |
| 6 | SWLS入力UI | 自由回答のUI形式（テキスト/選択肢/混在） | Med |

---

## 変更履歴

| 日付 | Ver | 変更内容 |
|---|---:|---|
| 2026-01-15 | 1.3 | クラウドSTT基本、音声短期保持、分岐ツリー、KPI/日次週次追加案 |
| 2026-01-15 | 1.4 | SWLSを任意・自由回答・別データに分離、イベント駆動データ設計、オフライン音声キュー（容量設定＋残り20分通知）を追加、分人状態推定はWon’tで明確化 |
| 2026-01-15 | 1.4.1 | 分岐ツリー保存バリデーション（終端分人必須）、音声保持オプション（有料・Won’t）、確定タスク/メモリー一覧ビュー、タスク状態遷移と2週間アーカイブを追加 |

