# 分人対応 音声文字起こし（16時間セッション）ハイブリッドSTT 要件定義書

**作成日**: 2026-02-18  
**バージョン**: 1.5.2  
**ステータス**: ドラフト（実施可能性レビュー反映版）  
**前版**: `【ARCHIVE】分人対応_音声文字起こしハイブリッドSTT_要件定義書_v1.5.0`

---

## 1. 決定事項（本版で確定）

1. Local STT第一候補は **Whisper系（whisper.cpp）**
2. ベンチマーク基準端末は **Google Pixel 9a**
3. Localモード時のサーバー送信は **テキストのみ**（音声は送信しない）
4. 将来を見据え、**複数AIエンジン切替可能**な構成にする
5. 方式変更適用は **次セグメントから**
6. `selectedMode / executedMode / fallbackReason` は **DB永続化必須**
7. KPI比較は **日次主軸（週次補助）**

---

## 2. 実施可能性レビュー（Feasibility Review）

## 2.1 技術実現性

| 項目 | 評価 | 根拠 | 対策 |
|---|---|---|---|
| Flutterでのモード選択/永続化 | 高 | 既存実装でSharedPreferences利用中 | 現実装を拡張 |
| Local STT (Whisper系) | 中 | Androidで実績多数だが端末差あり | Pixel 9aを基準に段階導入 |
| 複数エンジン切替 | 中 | 抽象化設計が必要 | Engine interfaceを先行導入 |
| テキストのみ送信 | 高 | API契約の変更で実装可能 | Local専用エンドポイント定義 |
| 長時間バックグラウンド運用 | 中 | 熱/バッテリー制約が強い | ジョブ制御・フォールバック実装 |

## 2.2 運用実現性

- 日次運用でモニタリング可能（フォールバック率、処理時間、失敗率）
- DBに `executedMode` と `fallbackReason` を残すことで障害解析が可能
- 端末差異は「基準端末達成 + 非基準端末はbest effort」で管理可能

## 2.3 リスクと判断

- 最大リスクは **熱/電池制約によるLocal推論の不安定化**
- 対応として、次を必須化する
  - タイムアウト制御
  - 失敗時Serverフォールバック
  - mode実行実績の永続化

**結論**: Phase分割を前提に実施可能。Phase1/2のゲート判定で進行可否を管理する。

---

## 3. 目的

Web SSOTの思想を維持しつつ、Server STT / Local STTの両モードを同一プロダクトで運用可能にする。

- **Server STTモード**: 既存どおりサーバーで音声文字起こし
- **Local STTモード**: 端末内（Whisper系）で文字起こしし、テキストのみ送信

---

## 4. 機能要件（Functional Requirements）

## 4.1 認証後のモード選択

- FR-001: ログイン後、mode未選択ユーザーには方式選択画面を表示する
- FR-002: 選択肢は `Server` / `Local` の2つを必須表示する
- FR-003: 選択結果を端末に永続化する
- FR-004: mode選択済みユーザーは直接ホームへ遷移する

## 4.2 モード変更

- FR-005: 設定画面からmode変更可能
- FR-006: 変更反映タイミングは **次セグメントから**
- FR-007: 変更時にUI通知（トースト等）を表示する

## 4.3 文字起こし実行

- FR-008: セグメント生成時に `selectedMode` を固定する
- FR-009: Local選択時はWhisper系エンジンを第一優先で利用する
- FR-010: Local失敗時はServerへフォールバック可能とする
- FR-011: `executedMode` は実際に実行された方式を必ず記録する

## 4.4 送信データ境界

- FR-012: Localモード時、サーバーへ送るペイロードは **テキスト+最小メタのみ**
- FR-013: Localモード時、音声ファイルをサーバーへ送信しない
- FR-014: Serverモード時は既存音声アップロード経路を維持する

## 4.5 監査・永続化

- FR-015: 各セグメントに `selectedMode` を保存する
- FR-016: 各セグメントに `executedMode` を保存する
- FR-017: フォールバック発生時は `fallbackReason` を保存する
- FR-018: 上記3項目はログだけでなくDB永続化する

## 4.6 KPI

- FR-019: KPIは日次で集計・可視化する
- FR-020: 週次はサマリ比較用途で補助利用する
- FR-021: Server/Local別の成功率・失敗率・処理時間を分離集計する

---

## 5. 非機能要件（NFR）

- NFR-001: Pixel 9aで60秒音声のLocal STTは P95 20秒以内
- NFR-002: Pixel 9aで300秒音声のLocal STTは P95 90秒以内
- NFR-003: 連続2時間運用でクラッシュ0件
- NFR-004: フォールバック時、ユーザー操作不要で処理継続
- NFR-005: テキスト送信APIは既存認証/RLS要件を満たす

---

## 6. アーキテクチャ要件

## 6.1 抽象化

- `TranscribeEngine` interfaceを定義
- 必須実装:
  - `WhisperEngine`
  - `ServerFallbackEngine`
- 将来実装:
  - `AltLocalEngine`（別AIエンジン）

## 6.2 ルーティング

- `EngineResolver` が以下を入力に実行方式を決定する
  - `selectedMode`
  - 端末状態（温度/リソース）
  - エンジン可用性（モデル配置有無）

## 6.3 データモデル（必須）

- `transcribeMode`（= selectedMode）
- `executedMode`
- `fallbackReason`
- `localEngineVersion`
- `sttProvider`

---

## 7. API要件

- Local用テキスト投入エンドポイントを正式化
- Server用 `/api/transcribe` は後方互換で維持
- Local時は音声multipartを禁止（バリデーションで拒否）

---

## 8. Pixel 9aベンチマーク要件

## 8.1 計測条件
- 音声長: 30秒 / 60秒 / 300秒
- 条件: 画面ON / 画面OFF / 充電中 / 非充電

## 8.2 計測項目
- 推論時間（avg/P95）
- CPUピーク
- メモリピーク
- 温度警告回数
- フォールバック率

## 8.3 合否判定
- NFR基準を満たした時のみ「Local正式導入可」と判定

---

## 9. フェーズとゲート

### Phase 1（基盤）
- mode選択・設定変更
- `selected/executed/fallback` データ通線
- Local時テキストのみ送信を実装

**ゲート1**: 監査項目がDBで取得可能

### Phase 2（Whisper導入）
- WhisperEngine導入
- Pixel 9aベンチ実施

**ゲート2**: NFR基準達成、重大障害なし

### Phase 3（最適化）
- 複数エンジン切替の本格運用
- 端末状態に応じた切替最適化

---

## 10. 受け入れ基準（Acceptance Criteria）

- AC-001: ログイン直後にmode未選択なら選択画面が表示される
- AC-002: mode変更は次セグメントから反映される
- AC-003: Local時にサーバーへ音声が送信されない
- AC-004: 各セグメントで `selectedMode/executedMode/fallbackReason` がDB確認できる
- AC-005: KPIダッシュボードで日次のmode別指標が確認できる

