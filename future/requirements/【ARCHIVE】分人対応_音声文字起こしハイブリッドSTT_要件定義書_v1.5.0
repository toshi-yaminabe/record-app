# 【ARCHIVE】分人対応 音声文字起こし（16時間セッション）ハイブリッドSTT 要件定義書

**作成日**: 2026-02-17  
**バージョン**: 1.5.0  
**ステータス**: アーカイブ（v1.5.1 実装方針確定版へ移行）  
**前版**: `【ARCHIVE】分人対応_音声文字起こしWebSSOT_要件定義書_v1.4.1`

---

## 1. 目的

v1.4.1の「Web SSOT + クラウドSTT」前提を拡張し、以下の2方式を同一プロダクトで扱えるようにする。

- **Server STTモード**: 既存どおり、サーバーで文字起こし
- **Local STTモード**: 端末内で文字起こし（将来本実装）

本版の狙いは、
1) UXとしてログイン後に方式選択可能にすること、
2) データモデル/イベント/監査設計を両モードで共通化すること、
3) Local実装前でもServer運用を壊さず段階導入できること。

---

## 2. スコープ

### 2.1 今回スコープ
- ログイン後に文字起こし方式を選択するUI（Server / Local）
- 選択結果の端末永続化
- 録音→セグメント→文字起こし処理に「方式(mode)」を引き回す
- 方式別のステータス・エラーコード・監査イベントを定義
- 既存Server STT運用と互換なフォールバック設計

### 2.2 スコープ外
- Local STTエンジン本実装（Whisper/ML Kit等の最終選定・導入）
- Local STT精度最適化、言語モデル更新配信
- Web版での同等UI統合（別トラック）

---

## 3. 方式別アーキテクチャ（再設計）

### 3.1 共通方針
- **SSOTはテキストとメタ情報**（音声永続保存は行わない）
- セグメントごとに `transcribeMode` を持つ（`SERVER` / `LOCAL`）
- Downstream（蒸留/提案/週次）は、テキスト確定後の共通パイプラインを利用

### 3.2 Server STTモード
1. 端末で録音セグメント生成
2. APIへアップロード
3. サーバーでSTT実行
4. テキスト確定保存
5. 音声削除

### 3.3 Local STTモード
1. 端末で録音セグメント生成
2. 端末内STTでテキスト化
3. APIへは **テキスト+最小メタのみ送信**（音声は原則送信しない）
4. サーバー側で共通パイプラインへ投入
5. 音声削除

### 3.4 フォールバック戦略（段階導入）
- Localモード選択時でも、Localエンジン未準備/失敗時はServer STTへフォールバック可能
- ただし監査上、以下を必須記録:
  - `selectedMode`（ユーザー選択）
  - `executedMode`（実際に実行した方式）
  - `fallbackReason`

---

## 4. セッション/状態遷移

### 4.1 ログイン後の遷移
- 認証済み && mode未選択 → 方式選択画面へ遷移
- 認証済み && mode選択済み → ホームへ遷移

### 4.2 方式変更
- 設定画面からいつでも変更可能
- 変更は「次セグメント」から適用（録音中セグメントは開始時mode固定）

### 4.3 セグメント状態
- `RECORDED`
- `TRANSCRIBING`
- `TRANSCRIBED`
- `FAILED_RETRYABLE`
- `FAILED_FINAL`

各状態に `transcribeMode`, `executedMode`, `errorCode`, `retryCount` を紐づける。

---

## 5. データ契約（必須フィールド）

## 5.1 Segment（論理モデル）
- `id`
- `sessionId`
- `segmentNo`
- `startAt`, `endAt`
- `text`
- `transcribeMode`（ユーザー選択）
- `executedMode`（実際に実行した方式）
- `sttStatus`
- `sttProvider`（Server時）
- `localEngineVersion`（Local時）
- `fallbackReason`（該当時）

## 5.2 API互換性
- 既存 `/api/transcribe` は維持
- 将来拡張で、`mode` フィールドを受け取れるようにする
- Local確定時は `POST /api/segments` へテキスト投入する経路を正式化

---

## 6. セキュリティ/プライバシー

- Serverモード: 既存の短期音声保持ポリシーを踏襲
- Localモード: 原則音声をサーバー送信しない
- いずれも最終保存対象はテキスト+メタ
- 監査ログにmode/fallback履歴を残し、説明可能性を確保

---

## 7. UX要件

- 方式選択画面で2モードの違いを明示
- Localが準備中の場合は「準備中」表示 + フォールバック説明
- 設定画面で現在方式を即確認できること
- 変更時はトースト等で反映結果を通知

---

## 8. 運用・可観測性

- KPIを方式別に分離計測
  - Server STT成功率
  - Local STT成功率
  - Local→Serverフォールバック率
- エラー分類
  - `LOCAL_ENGINE_UNAVAILABLE`
  - `LOCAL_ENGINE_TIMEOUT`
  - `SERVER_STT_TIMEOUT`
  - `SERVER_STT_5XX`
  - `EMPTY_TRANSCRIPT`

---

## 9. 実装フェーズ案

### Phase 1（今回）
- 方式選択UI
- 設定での再選択
- モード永続化
- モードを処理経路へ引き回し
- Local選択時はServerフォールバック（明示ログ）

### Phase 2
- Local STTエンジン導入
- 方式別メトリクス実装
- `executedMode` の永続化をAPI/DBへ反映

### Phase 3
- Local優先の安定化（精度/性能）
- 自動フェイルオーバー最適化

---

## 10. 確認事項（要回答）

1. **Local STTエンジン候補**
   - Whisper.cpp, ML Kit, Vosk など、優先候補はどれにするか
2. **Localモード時のサーバー送信方針**
   - テキストのみ送信で確定か、障害時のみ音声送信を許可するか
3. **方式変更の適用タイミング**
   - 現在案は「次セグメントから」。セッション単位固定にするか
4. **監査要件の厳しさ**
   - `selectedMode/executedMode/fallbackReason` をDB永続化するか、ログのみでよいか
5. **KPIの比較期間**
   - 方式別比較を週次で見るか、日次で見るか

---

## 11. 互換性メモ

- v1.4.1の思想（SSOTはテキスト、音声は短期保持）を維持
- 今回は「モード抽象化」を先に導入し、実際のLocal STT本体は段階導入
- 既存Server運用の停止や破壊的変更は行わない
